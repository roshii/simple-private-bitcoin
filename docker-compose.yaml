services:
  defaults: &defaults
    init: true
    pull_policy: always
    networks:
      - private
    restart: unless-stopped    

  build-defaults: &build-defaults
    context: ./build-context
    pull: true

  tor:
    <<: *defaults
    image: r0shii/tor:dev
    build:
      <<: *build-defaults
      dockerfile: tor.Dockerfile
    configs:
      - source: torrc
        target: /etc/tor/torrc
    container_name: tor
    networks:
      private:
        ipv4_address: 10.3.1.2
    volumes:
      - tor:/var/lib/tor

  bitcoin:
    <<: *defaults
    image: r0shii/bitcoin:dev
    build:
      <<: *build-defaults
      args:
        VERSION_TAG: v23.0
      dockerfile: bitcoin.Dockerfile
    configs:
      - source: bitcoin
        target: /home/satoshi/.bitcoin/bitcoin.conf
    container_name: bitcoin
    depends_on:
      - tor
    networks:
      private:
        ipv4_address: 10.3.1.3
    volumes_from:
        - tor:ro
    volumes:
        - bitcoin:/var/lib/bitcoin
        - ${BITCOIN_BLOCKS_MOUNTPOINT:-.data/bitcoin/.blocks}:/blocks
        - ${BITCOIN_DATA_MOUNTPOINT:-.data/bitcoin}:/home/satoshi/.bitcoin

  joinmarket:
    profiles:
    - do-not-start
    <<: *defaults
    image: r0shii/joinmarket:dev
    build:
      <<: *build-defaults
      args:
        VERSION_TAG: v0.9.8
      dockerfile: joinmarket.Dockerfile
    configs:
      - source: jm
        target: /srv/joinmarket.cfg
    container_name: joinmarket
    depends_on:
      bitcoin:
        condition: service_healthy
    volumes_from:
        - tor:ro
        - bitcoin:ro
    volumes:
      - ${JOINMARKET_DATA_MOUNTPOINT:-.data/joinmarket}:/srv

  lnd:
    <<: *defaults
    image: r0shii/lnd:dev
    build:
      <<: *build-defaults
      args:
        VERSION_TAG: v0.15.1-beta
      dockerfile: lnd
    container_name: lnd
    configs:
      - source: lnd
        target: /home/satoshi/.lnd/lnd.conf
    depends_on:
      bitcoin:
        condition: service_healthy
    volumes_from:
        - tor:ro
        - bitcoin:ro
    volumes:
      - ${LND_DATA_MOUNTPOINT:-.data/lnd}:/home/satoshi/.lnd

  lndconnect:
    <<: *defaults
    image: r0shii/lndconnect:dev
    build:
      <<: *build-defaults
      dockerfile: lndconnect.Dockerfile
    container_name: lndconnect
    depends_on:
      lnd:
        condition: service_healthy
    volumes_from:
        - tor:ro
        - lnd:rw

  lnlabs-defaults: &lnlabs-defaults
    <<: *defaults 
    depends_on:
      lnd:
        condition: service_healthy
    volumes_from:
        - lnd:ro

  # pool:
  #   <<: *lnlabs-defaults
  #   image: r0shii/pool:dev
  #   build:
  #     <<: *build-defaults
  #     args:
  #       SERVICE: pool
  #       VERSION_TAG: v0.5.8-alpha
  #     dockerfile: lnlabs-deamon.Dockerfile
  #   container_name: pool
  #   volumes:
  #     - ${POOL_DATA_MOUNTPOINT:-.data/pool}:/home/satoshi/.pool

  # loop:
  #   <<: *lnlabs-defaults
  #   image: r0shii/loop:dev
  #   build:
  #     <<: *build-defaults
  #     args:
  #       SERVICE: loop
  #       VERSION_TAG: v0.20.1-beta
  #     dockerfile: lnlabs-deamon.Dockerfile
  #   container_name: loop
  #   volumes:
  #     - ${LOOP_DATA_MOUNTPOINT:-.data/loop}:/home/satoshi/.loop
  
  # faraday:
  #   <<: *lnlabs-defaults
  #   image: r0shii/faraday:dev
  #   build:
  #     <<: *build-defaults
  #     args:
  #       SERVICE: faraday
  #       VERSION_TAG: v0.2.8-alpha
  #     dockerfile: lnlabs-deamon.Dockerfile
  #   container_name: faraday
  #   volumes:
  #     - ${FARADAY_DATA_MOUNTPOINT:-.data/faraday}:/home/satoshi/.faraday
  
  # lightning-terminal:
  #   <<: *lnlabs-defaults
  #   image: r0shii/lightning-terminal:dev
  #   build:
  #     <<: *build-defaults
  #     args:
  #       VERSION: v0.8.0-alpha
  #     dockerfile: lightning-terminal.Dockerfile
  #   container_name: lightning-terminal
  #   volumes_from:
  #     - faraday:ro
  #     - loop:ro
  #     - pool:ro
  #   volumes:
  #     - ${LIT_DATA_MOUNTPOINT:-.data/lightning-terminal}:/home/satoshi/.lit


networks:
  private:
    driver: bridge
    ipam:
      config:
        - subnet: 10.3.1.0/24

volumes:
  tor:
  bitcoin:

configs:
  torrc:
    file: ./configs/torrc
  bitcoin:
    file: ./configs/bitcoin.conf
  lnd:
    file: ./configs/lnd.conf
  jm:
    file: ./configs/joinmarket.cfg